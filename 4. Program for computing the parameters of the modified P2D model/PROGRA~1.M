clear all;
clc;
format long;
rand('seed',sum(clock));
E1=[200,20000];
E2=[20,2000];
E3=[200,20000];
E4=[-2000,-20];
E5=[0.3,0.5];
E6=[0.5,0.7];
E7=[20,2000];
E8=[0.2,1.8];
E9=[0.2,1.8];
E10=[0.1,0.9];
E11=[0.1,0.9];
E12=[0.5,2.0];
E13=[1000,2000];
E14=[3.6114,3.6114];
E15=[28000,32000];
E16=[40000,50000];
E17=[40,42];
E18=[0.01,0.04];
E19=[200,20000];
E20=[-20000,-200];
E21=[0.3,0.7];
E22=[0.3,0.7];
E23=[0.0,0.2];
aset=5;
bset=40;
cset=400;
dset=20;
isnmax=30;
ispmax=30;
iemax=60;
tchange=0.5;
pset=-15;
qset=-15;
IL1=xlsread('C:\Users\于子豪\Desktop\Program\Program\Data\Load current 1(average).xlsx','C2:C401');
IL2=xlsread('C:\Users\于子豪\Desktop\Program\Program\Data\Load current 1(instantaneous).xlsx','B2:B402');
Vm=xlsread('C:\Users\于子豪\Desktop\Program\Program\Data\Inter-electrode potential 1.xlsx','B2:B402');
tlength=xlsread('C:\Users\于子豪\Desktop\Program\Program\Data\Inter-electrode potential 1.xlsx','A402:A402');
EE1=zeros(1,bset);
EE2=zeros(1,bset);
EE3=zeros(1,bset);
EE4=zeros(1,bset);
EE5=zeros(1,bset);
EE6=zeros(1,bset);
EE7=zeros(1,bset);
EE8=zeros(1,bset);
EE9=zeros(1,bset);
EE10=zeros(1,bset);
EE11=zeros(1,bset);
EE12=zeros(1,bset);
EE13=zeros(1,bset);
EE14=zeros(1,bset);
EE15=zeros(1,bset);
EE16=zeros(1,bset);
EE17=zeros(1,bset);
EE18=zeros(1,bset);
EE19=zeros(1,bset);
EE20=zeros(1,bset);
EE21=zeros(1,bset);
EE22=zeros(1,bset);
EE23=zeros(1,bset);
e1=min(E1)+(max(E1)-min(E1))*rand;
e2=min(E2)+(max(E2)-min(E2))*rand;
e3=min(E3)+(max(E3)-min(E3))*rand;
e4=min(E4)+(max(E4)-min(E4))*rand;
e5=min(E5)+(max(E5)-min(E5))*rand;
e6=min(E6)+(max(E6)-min(E6))*rand;
e7=min(E7)+(max(E7)-min(E7))*rand;
e8=min(E8)+(max(E8)-min(E8))*rand;
e9=min(E9)+(max(E9)-min(E9))*rand;
e10=min(E10)+(max(E10)-min(E10))*rand;
e11=min(E11)+(max(E11)-min(E11))*rand;
e12=min(E12)+(max(E12)-min(E12))*rand;
e13=min(E13)+(max(E13)-min(E13))*rand;
e14=min(E14)+(max(E14)-min(E14))*rand;
e15=min(E15)+(max(E15)-min(E15))*rand;
e16=min(E16)+(max(E16)-min(E16))*rand;
e17=min(E17)+(max(E17)-min(E17))*rand;
e18=min(E18)+(max(E18)-min(E18))*rand;
e19=min(E19)+(max(E19)-min(E19))*rand;
e20=min(E20)+(max(E20)-min(E20))*rand;
e21=min(E21)+(max(E21)-min(E21))*rand;
e22=min(E22)+(max(E22)-min(E22))*rand;
e23=min(E23)+(max(E23)-min(E23))*rand;
while e10<e11||e10+e11<0.75||e10+e11>0.95||(e3*e8/e1)*e10*e12/(-e4*e9/e2)/e11<0.5||(e3*e8/e1)*e10*e12/(-e4*e9/e2)/e11>2||e1*e15/e3>34560||e1*e15/e3<30240||e2*e16/(-e4)>34560||e2*e16/(-e4)<30240||e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)>32400||e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)<29160||e1*e15/e3<e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)||e2*e16/(-e4)<e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)
  e1=min(E1)+(max(E1)-min(E1))*rand;
  e2=min(E2)+(max(E2)-min(E2))*rand;
  e3=min(E3)+(max(E3)-min(E3))*rand;
  e4=min(E4)+(max(E4)-min(E4))*rand;
  e5=min(E5)+(max(E5)-min(E5))*rand;
  e6=min(E6)+(max(E6)-min(E6))*rand;
  e7=min(E7)+(max(E7)-min(E7))*rand;
  e8=min(E8)+(max(E8)-min(E8))*rand;
  e9=min(E9)+(max(E9)-min(E9))*rand;
  e10=min(E10)+(max(E10)-min(E10))*rand;
  e11=min(E11)+(max(E11)-min(E11))*rand;
  e12=min(E12)+(max(E12)-min(E12))*rand;
  e13=min(E13)+(max(E13)-min(E13))*rand;
  e14=min(E14)+(max(E14)-min(E14))*rand;
  e15=min(E15)+(max(E15)-min(E15))*rand;
  e16=min(E16)+(max(E16)-min(E16))*rand;
  e17=min(E17)+(max(E17)-min(E17))*rand;
  e18=min(E18)+(max(E18)-min(E18))*rand;
  e19=min(E19)+(max(E19)-min(E19))*rand;
  e20=min(E20)+(max(E20)-min(E20))*rand;
  e21=min(E21)+(max(E21)-min(E21))*rand;
  e22=min(E22)+(max(E22)-min(E22))*rand;
  e23=min(E23)+(max(E23)-min(E23))*rand;
end
Vc=zeros(tlength/tchange+1,1);
Csn=(e5*e15)*ones(isnmax+1,1);
Csp=(e6*e16)*ones(ispmax+1,1);
Ce=e13*ones(iemax,1);
voltage=e14;
Vc(1,1)=voltage;
t=0;
n=0;
while t<=tlength-tchange
  Asn=diag([-ones(1,isnmax-1)+1./linspace(1,isnmax-1,isnmax-1),-1],-1)+diag([1,-ones(1,isnmax-1)-1./linspace(1,isnmax-1,isnmax-1)],1)+diag([-1,(e1/isnmax^2/tchange+2)*ones(1,isnmax-1),1],0);
  Bsn=diag([0,e1/isnmax^2/tchange*ones(1,isnmax-1),0],0)*Csn+[zeros(isnmax,1);-e3/isnmax*IL1(n+1,:)];
  Csn=Asn\Bsn;
  Asp=diag([-ones(1,ispmax-1)+1./linspace(1,ispmax-1,ispmax-1),-1],-1)+diag([1,-ones(1,ispmax-1)-1./linspace(1,ispmax-1,ispmax-1)],1)+diag([-1,(e2/ispmax^2/tchange+2)*ones(1,ispmax-1),1],0);
  Bsp=diag([0,e2/ispmax^2/tchange*ones(1,ispmax-1),0],0)*Csp+[zeros(ispmax,1);-e4/ispmax*IL1(n+1,:)];
  Csp=Asp\Bsp;
  Ae=diag([-ones(1,floor(e10*iemax)-1),-e12/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),-ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),-1/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),-ones(1,floor(e11*iemax))],-1)+diag([-ones(1,floor(e10*iemax)),-1/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),-ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),-(-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),-ones(1,floor(e11*iemax)-1)],1)+diag([e7/iemax^2/tchange+1,(e7/iemax^2/tchange+2)*ones(1,floor(e10*iemax)-1),e7/iemax^2/tchange+(e12+1)/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),(e7/iemax^2/tchange+2)*ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),e7/iemax^2/tchange+((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)+1)/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),(e7/iemax^2/tchange+2)*ones(1,floor(e11*iemax)-1),e7/iemax^2/tchange+1],0);
  Be=(e7/iemax^2/tchange)*Ce+(e7/iemax^2)*[(3*e3*e8/e1)*ones(1,floor(e10*iemax)),(3*e3*e8/e1)*(e10*iemax-floor(e10*iemax))/((e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))/e12),0*ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),(3*e4*e9/e2)*(e11*iemax-floor(e11*iemax))/((e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))/(-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)),(3*e4*e9/e2)*ones(1,floor(e11*iemax))]'*IL1(n+1,:);
  Ce=Ae\Be;
  ocp=e14-(log(e16/(e6*e16)-1)-log(e15/(e5*e15)-1))/e17+(log(Ce(iemax,1))-log(Ce(1,1)))/e17+(log(e16/Csp(ispmax+1,1)-1)-log(e15/Csn(isnmax+1,1)-1))/e17;
  phi=-IL2(n+2,:)*e18;
  etan=0;
  etap=0;
  p=0;
  q=0;
  while p>=pset
    while sign(IL2(n+2,:))*(exp((1-e21)*e17*etan)-exp(-e21*e17*etan))<sign(IL2(n+2,:))*(IL2(n+2,:)*(e13^(1-e21)*e19/Ce(1,1)^(1-e21))/(e15-Csn(isnmax+1,1))^(1-e21)/Csn(isnmax+1,1)^e21)
      etan=etan+sign(IL2(n+2,:))*10^p;
    end
    etan=etan-sign(IL2(n+2,:))*10^p;
    p=p-1;
  end
  while q>=qset
    while sign(-IL2(n+2,:))*(exp((1-e22)*e17*etap)-exp(-e22*e17*etap))<sign(-IL2(n+2,:))*(IL2(n+2,:)*(e13^(1-e22)*e20/Ce(iemax,1)^(1-e22))/(e16-Csp(ispmax+1,1))^(1-e22)/Csp(ispmax+1,1)^e22)
      etap=etap+sign(-IL2(n+2,:))*10^q;
    end
    etap=etap-sign(-IL2(n+2,:))*10^q;
    q=q-1;
  end
  eta=etap-etan;
  zeta=(e23-1/e17)*(log(Ce(iemax,1))-log(Ce(1,1)));
  voltage=ocp+phi+eta+zeta;
  Vc(n+2,1)=voltage;
  t=t+tchange;
  n=n+1;
end
a=1;
b=1;
c=1;
d=1;
while a<=aset
  while b<=bset
    while c<=cset
      ee1=e1+(((min(E1)-e1)+(max(E1)-e1))+sign(rand-0.5)*((min(E1)-e1)-(max(E1)-e1)))/2^(1+19*rand)*rand;
      ee2=e2+(((min(E2)-e2)+(max(E2)-e2))+sign(rand-0.5)*((min(E2)-e2)-(max(E2)-e2)))/2^(1+19*rand)*rand;
      ee3=e3+(((min(E3)-e3)+(max(E3)-e3))+sign(rand-0.5)*((min(E3)-e3)-(max(E3)-e3)))/2^(1+19*rand)*rand;
      ee4=e4+(((min(E4)-e4)+(max(E4)-e4))+sign(rand-0.5)*((min(E4)-e4)-(max(E4)-e4)))/2^(1+19*rand)*rand;
      ee5=e5+(((min(E5)-e5)+(max(E5)-e5))+sign(rand-0.5)*((min(E5)-e5)-(max(E5)-e5)))/2^(1+19*rand)*rand;
      ee6=e6+(((min(E6)-e6)+(max(E6)-e6))+sign(rand-0.5)*((min(E6)-e6)-(max(E6)-e6)))/2^(1+19*rand)*rand;
      ee7=e7+(((min(E7)-e7)+(max(E7)-e7))+sign(rand-0.5)*((min(E7)-e7)-(max(E7)-e7)))/2^(1+19*rand)*rand;
      ee8=e8+(((min(E8)-e8)+(max(E8)-e8))+sign(rand-0.5)*((min(E8)-e8)-(max(E8)-e8)))/2^(1+19*rand)*rand;
      ee9=e9+(((min(E9)-e9)+(max(E9)-e9))+sign(rand-0.5)*((min(E9)-e9)-(max(E9)-e9)))/2^(1+19*rand)*rand;
      ee10=e10+(((min(E10)-e10)+(max(E10)-e10))+sign(rand-0.5)*((min(E10)-e10)-(max(E10)-e10)))/2^(1+19*rand)*rand;
      ee11=e11+(((min(E11)-e11)+(max(E11)-e11))+sign(rand-0.5)*((min(E11)-e11)-(max(E11)-e11)))/2^(1+19*rand)*rand;
      ee12=e12+(((min(E12)-e12)+(max(E12)-e12))+sign(rand-0.5)*((min(E12)-e12)-(max(E12)-e12)))/2^(1+19*rand)*rand;
      ee13=e13+(((min(E13)-e13)+(max(E13)-e13))+sign(rand-0.5)*((min(E13)-e13)-(max(E13)-e13)))/2^(1+19*rand)*rand;
      ee14=e14+(((min(E14)-e14)+(max(E14)-e14))+sign(rand-0.5)*((min(E14)-e14)-(max(E14)-e14)))/2^(1+19*rand)*rand;
      ee15=e15+(((min(E15)-e15)+(max(E15)-e15))+sign(rand-0.5)*((min(E15)-e15)-(max(E15)-e15)))/2^(1+19*rand)*rand;
      ee16=e16+(((min(E16)-e16)+(max(E16)-e16))+sign(rand-0.5)*((min(E16)-e16)-(max(E16)-e16)))/2^(1+19*rand)*rand;
      ee17=e17+(((min(E17)-e17)+(max(E17)-e17))+sign(rand-0.5)*((min(E17)-e17)-(max(E17)-e17)))/2^(1+19*rand)*rand;
      ee18=e18+(((min(E18)-e18)+(max(E18)-e18))+sign(rand-0.5)*((min(E18)-e18)-(max(E18)-e18)))/2^(1+19*rand)*rand;
      ee19=e19+(((min(E19)-e19)+(max(E19)-e19))+sign(rand-0.5)*((min(E19)-e19)-(max(E19)-e19)))/2^(1+19*rand)*rand;
      ee20=e20+(((min(E20)-e20)+(max(E20)-e20))+sign(rand-0.5)*((min(E20)-e20)-(max(E20)-e20)))/2^(1+19*rand)*rand;
      ee21=e21+(((min(E21)-e21)+(max(E21)-e21))+sign(rand-0.5)*((min(E21)-e21)-(max(E21)-e21)))/2^(1+19*rand)*rand;
      ee22=e22+(((min(E22)-e22)+(max(E22)-e22))+sign(rand-0.5)*((min(E22)-e22)-(max(E22)-e22)))/2^(1+19*rand)*rand;
      ee23=e23+(((min(E23)-e23)+(max(E23)-e23))+sign(rand-0.5)*((min(E23)-e23)-(max(E23)-e23)))/2^(1+19*rand)*rand;
      while ee10<ee11||ee10+ee11<0.75||ee10+ee11>0.95||(ee3*ee8/ee1)*ee10*ee12/(-ee4*ee9/ee2)/ee11<0.5||(ee3*ee8/ee1)*ee10*ee12/(-ee4*ee9/ee2)/ee11>2||ee1*ee15/ee3>34560||ee1*ee15/ee3<30240||ee2*ee16/(-ee4)>34560||ee2*ee16/(-ee4)<30240||ee1*(ee5*ee15)/ee3+ee2*(ee6*ee16)/(-ee4)>32400||ee1*(ee5*ee15)/ee3+ee2*(ee6*ee16)/(-ee4)<29160||ee1*ee15/ee3<ee1*(ee5*ee15)/ee3+ee2*(ee6*ee16)/(-ee4)||ee2*ee16/(-ee4)<ee1*(ee5*ee15)/ee3+ee2*(ee6*ee16)/(-ee4)      
        ee1=e1+(((min(E1)-e1)+(max(E1)-e1))+sign(rand-0.5)*((min(E1)-e1)-(max(E1)-e1)))/2^(1+19*rand)*rand;
        ee2=e2+(((min(E2)-e2)+(max(E2)-e2))+sign(rand-0.5)*((min(E2)-e2)-(max(E2)-e2)))/2^(1+19*rand)*rand;
        ee3=e3+(((min(E3)-e3)+(max(E3)-e3))+sign(rand-0.5)*((min(E3)-e3)-(max(E3)-e3)))/2^(1+19*rand)*rand;
        ee4=e4+(((min(E4)-e4)+(max(E4)-e4))+sign(rand-0.5)*((min(E4)-e4)-(max(E4)-e4)))/2^(1+19*rand)*rand;
        ee5=e5+(((min(E5)-e5)+(max(E5)-e5))+sign(rand-0.5)*((min(E5)-e5)-(max(E5)-e5)))/2^(1+19*rand)*rand;
        ee6=e6+(((min(E6)-e6)+(max(E6)-e6))+sign(rand-0.5)*((min(E6)-e6)-(max(E6)-e6)))/2^(1+19*rand)*rand;
        ee7=e7+(((min(E7)-e7)+(max(E7)-e7))+sign(rand-0.5)*((min(E7)-e7)-(max(E7)-e7)))/2^(1+19*rand)*rand;
        ee8=e8+(((min(E8)-e8)+(max(E8)-e8))+sign(rand-0.5)*((min(E8)-e8)-(max(E8)-e8)))/2^(1+19*rand)*rand;
        ee9=e9+(((min(E9)-e9)+(max(E9)-e9))+sign(rand-0.5)*((min(E9)-e9)-(max(E9)-e9)))/2^(1+19*rand)*rand;
        ee10=e10+(((min(E10)-e10)+(max(E10)-e10))+sign(rand-0.5)*((min(E10)-e10)-(max(E10)-e10)))/2^(1+19*rand)*rand;
        ee11=e11+(((min(E11)-e11)+(max(E11)-e11))+sign(rand-0.5)*((min(E11)-e11)-(max(E11)-e11)))/2^(1+19*rand)*rand;
        ee12=e12+(((min(E12)-e12)+(max(E12)-e12))+sign(rand-0.5)*((min(E12)-e12)-(max(E12)-e12)))/2^(1+19*rand)*rand;
        ee13=e13+(((min(E13)-e13)+(max(E13)-e13))+sign(rand-0.5)*((min(E13)-e13)-(max(E13)-e13)))/2^(1+19*rand)*rand;
        ee14=e14+(((min(E14)-e14)+(max(E14)-e14))+sign(rand-0.5)*((min(E14)-e14)-(max(E14)-e14)))/2^(1+19*rand)*rand;
        ee15=e15+(((min(E15)-e15)+(max(E15)-e15))+sign(rand-0.5)*((min(E15)-e15)-(max(E15)-e15)))/2^(1+19*rand)*rand;
        ee16=e16+(((min(E16)-e16)+(max(E16)-e16))+sign(rand-0.5)*((min(E16)-e16)-(max(E16)-e16)))/2^(1+19*rand)*rand;
        ee17=e17+(((min(E17)-e17)+(max(E17)-e17))+sign(rand-0.5)*((min(E17)-e17)-(max(E17)-e17)))/2^(1+19*rand)*rand;
        ee18=e18+(((min(E18)-e18)+(max(E18)-e18))+sign(rand-0.5)*((min(E18)-e18)-(max(E18)-e18)))/2^(1+19*rand)*rand;
        ee19=e19+(((min(E19)-e19)+(max(E19)-e19))+sign(rand-0.5)*((min(E19)-e19)-(max(E19)-e19)))/2^(1+19*rand)*rand;
        ee20=e20+(((min(E20)-e20)+(max(E20)-e20))+sign(rand-0.5)*((min(E20)-e20)-(max(E20)-e20)))/2^(1+19*rand)*rand;
        ee21=e21+(((min(E21)-e21)+(max(E21)-e21))+sign(rand-0.5)*((min(E21)-e21)-(max(E21)-e21)))/2^(1+19*rand)*rand;
        ee22=e22+(((min(E22)-e22)+(max(E22)-e22))+sign(rand-0.5)*((min(E22)-e22)-(max(E22)-e22)))/2^(1+19*rand)*rand;
        ee23=e23+(((min(E23)-e23)+(max(E23)-e23))+sign(rand-0.5)*((min(E23)-e23)-(max(E23)-e23)))/2^(1+19*rand)*rand;
      end
      VVc=zeros(tlength/tchange+1,1);
      Csn=(ee5*ee15)*ones(isnmax+1,1);
      Csp=(ee6*ee16)*ones(ispmax+1,1);
      Ce=ee13*ones(iemax,1);
      voltage=ee14;
      VVc(1,1)=voltage;
      t=0;
      n=0;
      while t<=tlength-tchange
        Asn=diag([-ones(1,isnmax-1)+1./linspace(1,isnmax-1,isnmax-1),-1],-1)+diag([1,-ones(1,isnmax-1)-1./linspace(1,isnmax-1,isnmax-1)],1)+diag([-1,(ee1/isnmax^2/tchange+2)*ones(1,isnmax-1),1],0);
        Bsn=diag([0,ee1/isnmax^2/tchange*ones(1,isnmax-1),0],0)*Csn+[zeros(isnmax,1);-ee3/isnmax*IL1(n+1,:)];
        Csn=Asn\Bsn;
        Asp=diag([-ones(1,ispmax-1)+1./linspace(1,ispmax-1,ispmax-1),-1],-1)+diag([1,-ones(1,ispmax-1)-1./linspace(1,ispmax-1,ispmax-1)],1)+diag([-1,(ee2/ispmax^2/tchange+2)*ones(1,ispmax-1),1],0);
        Bsp=diag([0,ee2/ispmax^2/tchange*ones(1,ispmax-1),0],0)*Csp+[zeros(ispmax,1);-ee4/ispmax*IL1(n+1,:)];
        Csp=Asp\Bsp;
        Ae=diag([-ones(1,floor(ee10*iemax)-1),-ee12/(ee12*(ee10*iemax-floor(ee10*iemax))+(1-ee10*iemax+floor(ee10*iemax))),-ones(1,iemax-2-floor(ee10*iemax)-floor(ee11*iemax)),-1/((-(3*ee3*ee8/ee1)*ee10*ee12/(3*ee4*ee9/ee2)/ee11)*(ee11*iemax-floor(ee11*iemax))+(1-ee11*iemax+floor(ee11*iemax))),-ones(1,floor(ee11*iemax))],-1)+diag([-ones(1,floor(ee10*iemax)),-1/(ee12*(ee10*iemax-floor(ee10*iemax))+(1-ee10*iemax+floor(ee10*iemax))),-ones(1,iemax-2-floor(ee10*iemax)-floor(ee11*iemax)),-(-(3*ee3*ee8/ee1)*ee10*ee12/(3*ee4*ee9/ee2)/ee11)/((-(3*ee3*ee8/ee1)*ee10*ee12/(3*ee4*ee9/ee2)/ee11)*(ee11*iemax-floor(ee11*iemax))+(1-ee11*iemax+floor(ee11*iemax))),-ones(1,floor(ee11*iemax)-1)],1)+diag([ee7/iemax^2/tchange+1,(ee7/iemax^2/tchange+2)*ones(1,floor(ee10*iemax)-1),ee7/iemax^2/tchange+(ee12+1)/(ee12*(ee10*iemax-floor(ee10*iemax))+(1-ee10*iemax+floor(ee10*iemax))),(ee7/iemax^2/tchange+2)*ones(1,iemax-2-floor(ee10*iemax)-floor(ee11*iemax)),ee7/iemax^2/tchange+((-(3*ee3*ee8/ee1)*ee10*ee12/(3*ee4*ee9/ee2)/ee11)+1)/((-(3*ee3*ee8/ee1)*ee10*ee12/(3*ee4*ee9/ee2)/ee11)*(ee11*iemax-floor(ee11*iemax))+(1-ee11*iemax+floor(ee11*iemax))),(ee7/iemax^2/tchange+2)*ones(1,floor(ee11*iemax)-1),ee7/iemax^2/tchange+1],0);
        Be=(ee7/iemax^2/tchange)*Ce+(ee7/iemax^2)*[(3*ee3*ee8/ee1)*ones(1,floor(ee10*iemax)),(3*ee3*ee8/ee1)*(ee10*iemax-floor(ee10*iemax))/((ee10*iemax-floor(ee10*iemax))+(1-ee10*iemax+floor(ee10*iemax))/ee12),0*ones(1,iemax-2-floor(ee10*iemax)-floor(ee11*iemax)),(3*ee4*ee9/ee2)*(ee11*iemax-floor(ee11*iemax))/((ee11*iemax-floor(ee11*iemax))+(1-ee11*iemax+floor(ee11*iemax))/(-(3*ee3*ee8/ee1)*ee10*ee12/(3*ee4*ee9/ee2)/ee11)),(3*ee4*ee9/ee2)*ones(1,floor(ee11*iemax))]'*IL1(n+1,:);
        Ce=Ae\Be;
        ocp=ee14-(log(ee16/(ee6*ee16)-1)-log(ee15/(ee5*ee15)-1))/ee17+(log(Ce(iemax,1))-log(Ce(1,1)))/ee17+(log(ee16/Csp(ispmax+1,1)-1)-log(ee15/Csn(isnmax+1,1)-1))/ee17;
        phi=-IL2(n+2,:)*ee18;
        etan=0;
        etap=0;
        p=0;
        q=0;
        while p>=pset
          while sign(IL2(n+2,:))*(exp((1-ee21)*ee17*etan)-exp(-ee21*ee17*etan))<sign(IL2(n+2,:))*(IL2(n+2,:)*(ee13^(1-ee21)*ee19/Ce(1,1)^(1-ee21))/(ee15-Csn(isnmax+1,1))^(1-ee21)/Csn(isnmax+1,1)^ee21)
            etan=etan+sign(IL2(n+2,:))*10^p;
          end
          etan=etan-sign(IL2(n+2,:))*10^p;
          p=p-1;
        end
        while q>=qset
          while sign(-IL2(n+2,:))*(exp((1-ee22)*ee17*etap)-exp(-ee22*ee17*etap))<sign(-IL2(n+2,:))*(IL2(n+2,:)*(ee13^(1-ee22)*ee20/Ce(iemax,1)^(1-ee22))/(ee16-Csp(ispmax+1,1))^(1-ee22)/Csp(ispmax+1,1)^ee22)
            etap=etap+sign(-IL2(n+2,:))*10^q;
          end
            etap=etap-sign(-IL2(n+2,:))*10^q;
            q=q-1;
        end
        eta=etap-etan;
        zeta=(ee23-1/ee17)*(log(Ce(iemax,1))-log(Ce(1,1)));
        voltage=ocp+phi+eta+zeta;
        VVc(n+2,1)=voltage;
        t=t+tchange;
        n=n+1;
      end
      if d~=dset
        if norm(Vc-Vm)>norm(VVc-Vm)
          e1=ee1;
          e2=ee2;
          e3=ee3;
          e4=ee4;
          e5=ee5;
          e6=ee6;
          e7=ee7;
          e8=ee8;
          e9=ee9;
          e10=ee10;
          e11=ee11;
          e12=ee12;
          e13=ee13;
          e14=ee14;
          e15=ee15;
          e16=ee16;
          e17=ee17;
          e18=ee18;
          e19=ee19;
          e20=ee20;
          e21=ee21;
          e22=ee22;
          e23=ee23;
          Vc=VVc;
          c=c+1;
          d=1;
        else
          d=d+1;
        end
      else
        if norm(Vc-Vm)>norm(VVc-Vm)
          e1=ee1;
          e2=ee2;
          e3=ee3;
          e4=ee4;
          e5=ee5;
          e6=ee6;
          e7=ee7;
          e8=ee8;
          e9=ee9;
          e10=ee10;
          e11=ee11;
          e12=ee12;
          e13=ee13;
          e14=ee14;
          e15=ee15;
          e16=ee16;
          e17=ee17;
          e18=ee18;
          e19=ee19;
          e20=ee20;
          e21=ee21;
          e22=ee22;
          e23=ee23;
          Vc=VVc;
          c=c+1;
          d=1;
        else
          c=c+1;
          d=1;
        end
      end
    end
    if b~=bset
      EE1(1,b)=e1;
      EE2(1,b)=e2;
      EE3(1,b)=e3;
      EE4(1,b)=e4;
      EE5(1,b)=e5;
      EE6(1,b)=e6;
      EE7(1,b)=e7;
      EE8(1,b)=e8;
      EE9(1,b)=e9;
      EE10(1,b)=e10;
      EE11(1,b)=e11;
      EE12(1,b)=e12;
      EE13(1,b)=e13;
      EE14(1,b)=e14;
      EE15(1,b)=e15;
      EE16(1,b)=e16;
      EE17(1,b)=e17;
      EE18(1,b)=e18;
      EE19(1,b)=e19;
      EE20(1,b)=e20;
      EE21(1,b)=e21;
      EE22(1,b)=e22;
      EE23(1,b)=e23;
      e1=min(E1)+(max(E1)-min(E1))*rand;
      e2=min(E2)+(max(E2)-min(E2))*rand;
      e3=min(E3)+(max(E3)-min(E3))*rand;
      e4=min(E4)+(max(E4)-min(E4))*rand;
      e5=min(E5)+(max(E5)-min(E5))*rand;
      e6=min(E6)+(max(E6)-min(E6))*rand;
      e7=min(E7)+(max(E7)-min(E7))*rand;
      e8=min(E8)+(max(E8)-min(E8))*rand;
      e9=min(E9)+(max(E9)-min(E9))*rand;
      e10=min(E10)+(max(E10)-min(E10))*rand;
      e11=min(E11)+(max(E11)-min(E11))*rand;
      e12=min(E12)+(max(E12)-min(E12))*rand;
      e13=min(E13)+(max(E13)-min(E13))*rand;
      e14=min(E14)+(max(E14)-min(E14))*rand;
      e15=min(E15)+(max(E15)-min(E15))*rand;
      e16=min(E16)+(max(E16)-min(E16))*rand;
      e17=min(E17)+(max(E17)-min(E17))*rand;
      e18=min(E18)+(max(E18)-min(E18))*rand;
      e19=min(E19)+(max(E19)-min(E19))*rand;
      e20=min(E20)+(max(E20)-min(E20))*rand;
      e21=min(E21)+(max(E21)-min(E21))*rand;
      e22=min(E22)+(max(E22)-min(E22))*rand;
      e23=min(E23)+(max(E23)-min(E23))*rand;
      while e10<e11||e10+e11<0.75||e10+e11>0.95||(e3*e8/e1)*e10*e12/(-e4*e9/e2)/e11<0.5||(e3*e8/e1)*e10*e12/(-e4*e9/e2)/e11>2||e1*e15/e3>34560||e1*e15/e3<30240||e2*e16/(-e4)>34560||e2*e16/(-e4)<30240||e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)>32400||e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)<29160||e1*e15/e3<e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)||e2*e16/(-e4)<e1*(e5*e15)/e3+e2*(e6*e16)/(-e4) 
        e1=min(E1)+(max(E1)-min(E1))*rand;
        e2=min(E2)+(max(E2)-min(E2))*rand;
        e3=min(E3)+(max(E3)-min(E3))*rand;
        e4=min(E4)+(max(E4)-min(E4))*rand;
        e5=min(E5)+(max(E5)-min(E5))*rand;
        e6=min(E6)+(max(E6)-min(E6))*rand;
        e7=min(E7)+(max(E7)-min(E7))*rand;
        e8=min(E8)+(max(E8)-min(E8))*rand;
        e9=min(E9)+(max(E9)-min(E9))*rand;
        e10=min(E10)+(max(E10)-min(E10))*rand;
        e11=min(E11)+(max(E11)-min(E11))*rand;
        e12=min(E12)+(max(E12)-min(E12))*rand;
        e13=min(E13)+(max(E13)-min(E13))*rand;
        e14=min(E14)+(max(E14)-min(E14))*rand;
        e15=min(E15)+(max(E15)-min(E15))*rand;
        e16=min(E16)+(max(E16)-min(E16))*rand;
        e17=min(E17)+(max(E17)-min(E17))*rand;
        e18=min(E18)+(max(E18)-min(E18))*rand;
        e19=min(E19)+(max(E19)-min(E19))*rand;
        e20=min(E20)+(max(E20)-min(E20))*rand;
        e21=min(E21)+(max(E21)-min(E21))*rand;
        e22=min(E22)+(max(E22)-min(E22))*rand;
        e23=min(E23)+(max(E23)-min(E23))*rand;
      end
      Vc=zeros(tlength/tchange+1,1);
      Csn=(e5*e15)*ones(isnmax+1,1);
      Csp=(e6*e16)*ones(ispmax+1,1);
      Ce=e13*ones(iemax,1);
      voltage=e14;
      Vc(1,1)=voltage;
      t=0;
      n=0;
      while t<=tlength-tchange
        Asn=diag([-ones(1,isnmax-1)+1./linspace(1,isnmax-1,isnmax-1),-1],-1)+diag([1,-ones(1,isnmax-1)-1./linspace(1,isnmax-1,isnmax-1)],1)+diag([-1,(e1/isnmax^2/tchange+2)*ones(1,isnmax-1),1],0);
        Bsn=diag([0,e1/isnmax^2/tchange*ones(1,isnmax-1),0],0)*Csn+[zeros(isnmax,1);-e3/isnmax*IL1(n+1,:)];
        Csn=Asn\Bsn;
        Asp=diag([-ones(1,ispmax-1)+1./linspace(1,ispmax-1,ispmax-1),-1],-1)+diag([1,-ones(1,ispmax-1)-1./linspace(1,ispmax-1,ispmax-1)],1)+diag([-1,(e2/ispmax^2/tchange+2)*ones(1,ispmax-1),1],0);
        Bsp=diag([0,e2/ispmax^2/tchange*ones(1,ispmax-1),0],0)*Csp+[zeros(ispmax,1);-e4/ispmax*IL1(n+1,:)];
        Csp=Asp\Bsp;
        Ae=diag([-ones(1,floor(e10*iemax)-1),-e12/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),-ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),-1/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),-ones(1,floor(e11*iemax))],-1)+diag([-ones(1,floor(e10*iemax)),-1/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),-ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),-(-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),-ones(1,floor(e11*iemax)-1)],1)+diag([e7/iemax^2/tchange+1,(e7/iemax^2/tchange+2)*ones(1,floor(e10*iemax)-1),e7/iemax^2/tchange+(e12+1)/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),(e7/iemax^2/tchange+2)*ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),e7/iemax^2/tchange+((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)+1)/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),(e7/iemax^2/tchange+2)*ones(1,floor(e11*iemax)-1),e7/iemax^2/tchange+1],0);
        Be=(e7/iemax^2/tchange)*Ce+(e7/iemax^2)*[(3*e3*e8/e1)*ones(1,floor(e10*iemax)),(3*e3*e8/e1)*(e10*iemax-floor(e10*iemax))/((e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))/e12),0*ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),(3*e4*e9/e2)*(e11*iemax-floor(e11*iemax))/((e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))/(-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)),(3*e4*e9/e2)*ones(1,floor(e11*iemax))]'*IL1(n+1,:);
        Ce=Ae\Be;
        ocp=e14-(log(e16/(e6*e16)-1)-log(e15/(e5*e15)-1))/e17+(log(Ce(iemax,1))-log(Ce(1,1)))/e17+(log(e16/Csp(ispmax+1,1)-1)-log(e15/Csn(isnmax+1,1)-1))/e17;
        phi=-IL2(n+2,:)*e18;
        etan=0;
        etap=0;
        p=0;
        q=0;
        while p>=pset
          while sign(IL2(n+2,:))*(exp((1-e21)*e17*etan)-exp(-e21*e17*etan))<sign(IL2(n+2,:))*(IL2(n+2,:)*(e13^(1-e21)*e19/Ce(1,1)^(1-e21))/(e15-Csn(isnmax+1,1))^(1-e21)/Csn(isnmax+1,1)^e21)
            etan=etan+sign(IL2(n+2,:))*10^p;
          end
          etan=etan-sign(IL2(n+2,:))*10^p;
          p=p-1;
        end
        while q>=qset
          while sign(-IL2(n+2,:))*(exp((1-e22)*e17*etap)-exp(-e22*e17*etap))<sign(-IL2(n+2,:))*(IL2(n+2,:)*(e13^(1-e22)*e20/Ce(iemax,1)^(1-e22))/(e16-Csp(ispmax+1,1))^(1-e22)/Csp(ispmax+1,1)^e22)
            etap=etap+sign(-IL2(n+2,:))*10^q;
          end
          etap=etap-sign(-IL2(n+2,:))*10^q;
          q=q-1;
        end
        eta=etap-etan;
        zeta=(e23-1/e17)*(log(Ce(iemax,1))-log(Ce(1,1)));
        voltage=ocp+phi+eta+zeta;
        Vc(n+2,1)=voltage;
        t=t+tchange;
        n=n+1;
      end
      b=b+1;
      c=1;
      d=1;
    else
      EE1(1,b)=e1;
      EE2(1,b)=e2;
      EE3(1,b)=e3;
      EE4(1,b)=e4;
      EE5(1,b)=e5;
      EE6(1,b)=e6;
      EE7(1,b)=e7;
      EE8(1,b)=e8;
      EE9(1,b)=e9;
      EE10(1,b)=e10;
      EE11(1,b)=e11;
      EE12(1,b)=e12;
      EE13(1,b)=e13;
      EE14(1,b)=e14;
      EE15(1,b)=e15;
      EE16(1,b)=e16;
      EE17(1,b)=e17;
      EE18(1,b)=e18;
      EE19(1,b)=e19;
      EE20(1,b)=e20;
      EE21(1,b)=e21;
      EE22(1,b)=e22;
      EE23(1,b)=e23;
      b=b+1;
      c=1;
      d=1;
    end
  end
  if a~=aset
    E1=EE1;
    E2=EE2;
    E3=EE3;
    E4=EE4;
    E5=EE5;
    E6=EE6;
    E7=EE7;
    E8=EE8;
    E9=EE9;
    E10=EE10;
    E11=EE11;
    E12=EE12;
    E13=EE13;
    E14=EE14;
    E15=EE15;
    E16=EE16;
    E17=EE17;
    E18=EE18;
    E19=EE19;
    E20=EE20;
    E21=EE21;
    E22=EE22;
    E23=EE23;
    E=[E1;E2;E3;E4;E5;E6;E7;E8;E9;E10;E11;E12;E13;E14;E15;E16;E17;E18;E19;E20;E21;E22;E23];
    xlswrite('C:\Users\于子豪\Desktop\Program\Program\Parameters 1.xlsx',E,'A1:AN23');
    EE1=zeros(1,bset);
    EE2=zeros(1,bset);
    EE3=zeros(1,bset);
    EE4=zeros(1,bset);
    EE5=zeros(1,bset);
    EE6=zeros(1,bset);
    EE7=zeros(1,bset);
    EE8=zeros(1,bset);
    EE9=zeros(1,bset);
    EE10=zeros(1,bset);
    EE11=zeros(1,bset);
    EE12=zeros(1,bset);
    EE13=zeros(1,bset);
    EE14=zeros(1,bset);
    EE15=zeros(1,bset);
    EE16=zeros(1,bset);
    EE17=zeros(1,bset);
    EE18=zeros(1,bset);
    EE19=zeros(1,bset);
    EE20=zeros(1,bset);
    EE21=zeros(1,bset);
    EE22=zeros(1,bset);
    EE23=zeros(1,bset);
    e1=min(E1)+(max(E1)-min(E1))*rand;
    e2=min(E2)+(max(E2)-min(E2))*rand;
    e3=min(E3)+(max(E3)-min(E3))*rand;
    e4=min(E4)+(max(E4)-min(E4))*rand;
    e5=min(E5)+(max(E5)-min(E5))*rand;
    e6=min(E6)+(max(E6)-min(E6))*rand;
    e7=min(E7)+(max(E7)-min(E7))*rand;
    e8=min(E8)+(max(E8)-min(E8))*rand;
    e9=min(E9)+(max(E9)-min(E9))*rand;
    e10=min(E10)+(max(E10)-min(E10))*rand;
    e11=min(E11)+(max(E11)-min(E11))*rand;
    e12=min(E12)+(max(E12)-min(E12))*rand;
    e13=min(E13)+(max(E13)-min(E13))*rand;
    e14=min(E14)+(max(E14)-min(E14))*rand;
    e15=min(E15)+(max(E15)-min(E15))*rand;
    e16=min(E16)+(max(E16)-min(E16))*rand;
    e17=min(E17)+(max(E17)-min(E17))*rand;
    e18=min(E18)+(max(E18)-min(E18))*rand;
    e19=min(E19)+(max(E19)-min(E19))*rand;
    e20=min(E20)+(max(E20)-min(E20))*rand;
    e21=min(E21)+(max(E21)-min(E21))*rand;
    e22=min(E22)+(max(E22)-min(E22))*rand;
    e23=min(E23)+(max(E23)-min(E23))*rand;
    while e10<e11||e10+e11<0.75||e10+e11>0.95||(e3*e8/e1)*e10*e12/(-e4*e9/e2)/e11<0.5||(e3*e8/e1)*e10*e12/(-e4*e9/e2)/e11>2||e1*e15/e3>34560||e1*e15/e3<30240||e2*e16/(-e4)>34560||e2*e16/(-e4)<30240||e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)>32400||e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)<29160||e1*e15/e3<e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)||e2*e16/(-e4)<e1*(e5*e15)/e3+e2*(e6*e16)/(-e4)
      e1=min(E1)+(max(E1)-min(E1))*rand;
      e2=min(E2)+(max(E2)-min(E2))*rand;
      e3=min(E3)+(max(E3)-min(E3))*rand;
      e4=min(E4)+(max(E4)-min(E4))*rand;
      e5=min(E5)+(max(E5)-min(E5))*rand;
      e6=min(E6)+(max(E6)-min(E6))*rand;
      e7=min(E7)+(max(E7)-min(E7))*rand;
      e8=min(E8)+(max(E8)-min(E8))*rand;
      e9=min(E9)+(max(E9)-min(E9))*rand;
      e10=min(E10)+(max(E10)-min(E10))*rand;
      e11=min(E11)+(max(E11)-min(E11))*rand;
      e12=min(E12)+(max(E12)-min(E12))*rand;
      e13=min(E13)+(max(E13)-min(E13))*rand;
      e14=min(E14)+(max(E14)-min(E14))*rand;
      e15=min(E15)+(max(E15)-min(E15))*rand;
      e16=min(E16)+(max(E16)-min(E16))*rand;
      e17=min(E17)+(max(E17)-min(E17))*rand;
      e18=min(E18)+(max(E18)-min(E18))*rand;
      e19=min(E19)+(max(E19)-min(E19))*rand;
      e20=min(E20)+(max(E20)-min(E20))*rand;
      e21=min(E21)+(max(E21)-min(E21))*rand;
      e22=min(E22)+(max(E22)-min(E22))*rand;
      e23=min(E23)+(max(E23)-min(E23))*rand;
    end
    Vc=zeros(tlength/tchange+1,1);
    Csn=(e5*e15)*ones(isnmax+1,1);
    Csp=(e6*e16)*ones(ispmax+1,1);
    Ce=e13*ones(iemax,1);
    voltage=e14;
    Vc(1,1)=voltage;
    t=0;
    n=0;
    while t<=tlength-tchange
      Asn=diag([-ones(1,isnmax-1)+1./linspace(1,isnmax-1,isnmax-1),-1],-1)+diag([1,-ones(1,isnmax-1)-1./linspace(1,isnmax-1,isnmax-1)],1)+diag([-1,(e1/isnmax^2/tchange+2)*ones(1,isnmax-1),1],0);
      Bsn=diag([0,e1/isnmax^2/tchange*ones(1,isnmax-1),0],0)*Csn+[zeros(isnmax,1);-e3/isnmax*IL1(n+1,:)];
      Csn=Asn\Bsn;
      Asp=diag([-ones(1,ispmax-1)+1./linspace(1,ispmax-1,ispmax-1),-1],-1)+diag([1,-ones(1,ispmax-1)-1./linspace(1,ispmax-1,ispmax-1)],1)+diag([-1,(e2/ispmax^2/tchange+2)*ones(1,ispmax-1),1],0);
      Bsp=diag([0,e2/ispmax^2/tchange*ones(1,ispmax-1),0],0)*Csp+[zeros(ispmax,1);-e4/ispmax*IL1(n+1,:)];
      Csp=Asp\Bsp;
      Ae=diag([-ones(1,floor(e10*iemax)-1),-e12/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),-ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),-1/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),-ones(1,floor(e11*iemax))],-1)+diag([-ones(1,floor(e10*iemax)),-1/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),-ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),-(-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),-ones(1,floor(e11*iemax)-1)],1)+diag([e7/iemax^2/tchange+1,(e7/iemax^2/tchange+2)*ones(1,floor(e10*iemax)-1),e7/iemax^2/tchange+(e12+1)/(e12*(e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))),(e7/iemax^2/tchange+2)*ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),e7/iemax^2/tchange+((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)+1)/((-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)*(e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))),(e7/iemax^2/tchange+2)*ones(1,floor(e11*iemax)-1),e7/iemax^2/tchange+1],0);
      Be=(e7/iemax^2/tchange)*Ce+(e7/iemax^2)*[(3*e3*e8/e1)*ones(1,floor(e10*iemax)),(3*e3*e8/e1)*(e10*iemax-floor(e10*iemax))/((e10*iemax-floor(e10*iemax))+(1-e10*iemax+floor(e10*iemax))/e12),0*ones(1,iemax-2-floor(e10*iemax)-floor(e11*iemax)),(3*e4*e9/e2)*(e11*iemax-floor(e11*iemax))/((e11*iemax-floor(e11*iemax))+(1-e11*iemax+floor(e11*iemax))/(-(3*e3*e8/e1)*e10*e12/(3*e4*e9/e2)/e11)),(3*e4*e9/e2)*ones(1,floor(e11*iemax))]'*IL1(n+1,:);
      Ce=Ae\Be;
      ocp=e14-(log(e16/(e6*e16)-1)-log(e15/(e5*e15)-1))/e17+(log(Ce(iemax,1))-log(Ce(1,1)))/e17+(log(e16/Csp(ispmax+1,1)-1)-log(e15/Csn(isnmax+1,1)-1))/e17;
      phi=-IL2(n+2,:)*e18;
      etan=0;
      etap=0;
      p=0;
      q=0;
      while p>=pset
        while sign(IL2(n+2,:))*(exp((1-e21)*e17*etan)-exp(-e21*e17*etan))<sign(IL2(n+2,:))*(IL2(n+2,:)*(e13^(1-e21)*e19/Ce(1,1)^(1-e21))/(e15-Csn(isnmax+1,1))^(1-e21)/Csn(isnmax+1,1)^e21)
          etan=etan+sign(IL2(n+2,:))*10^p;
        end
        etan=etan-sign(IL2(n+2,:))*10^p;
        p=p-1;
      end
      while q>=qset
        while sign(-IL2(n+2,:))*(exp((1-e22)*e17*etap)-exp(-e22*e17*etap))<sign(-IL2(n+2,:))*(IL2(n+2,:)*(e13^(1-e22)*e20/Ce(iemax,1)^(1-e22))/(e16-Csp(ispmax+1,1))^(1-e22)/Csp(ispmax+1,1)^e22)
          etap=etap+sign(-IL2(n+2,:))*10^q;
        end
        etap=etap-sign(-IL2(n+2,:))*10^q;
        q=q-1;
      end
      eta=etap-etan;
      zeta=(e23-1/e17)*(log(Ce(iemax,1))-log(Ce(1,1)));
      voltage=ocp+phi+eta+zeta;
      Vc(n+2,1)=voltage;
      t=t+tchange;
      n=n+1;
    end
    a=a+1;
    b=1;
    c=1;
    d=1;
  else
    E1=EE1;
    E2=EE2;
    E3=EE3;
    E4=EE4;
    E5=EE5;
    E6=EE6;
    E7=EE7;
    E8=EE8;
    E9=EE9;
    E10=EE10;
    E11=EE11;
    E12=EE12;
    E13=EE13;
    E14=EE14;
    E15=EE15;
    E16=EE16;
    E17=EE17;
    E18=EE18;
    E19=EE19;
    E20=EE20;
    E21=EE21;
    E22=EE22;
    E23=EE23;
    E=[E1;E2;E3;E4;E5;E6;E7;E8;E9;E10;E11;E12;E13;E14;E15;E16;E17;E18;E19;E20;E21;E22;E23];
    xlswrite('C:\Users\于子豪\Desktop\Program\Program\Parameters 1.xlsx',E,'A1:AN23');
    a=a+1;
    b=1;
    c=1;
    d=1;
  end
end

